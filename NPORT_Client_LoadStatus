---EXEC sp_set_session_context @key=N'SystemUserName', @value='SYSTEM'

SELECT

cl.ClientName
,cl.ClientCode
,cl.Active
,cl.SFTPPrefix
,ls.CreatedUser
,ls.OriginalFileName
,case when ls.OriginalFileName IS NOT NULL then 1 else NULL end as OriginalFileName_Count
,ls.ObjectName
,ls.ObjectType
,ls.ProcessStage
,ls.CreatedUser as LoadStatus_CreatedUser

---JobGuid
,ls.JobGuid
,cast((max(ls.JobStartDateTime) OVER(PARTITION BY ls.JobGuid) - min(ls.JobStartDateTime) OVER(PARTITION BY ls.JobGuid)) as TIME (0)) as JobGuid_Duration

---File Status
,ls.FileState
,ls.StatusCode
,case when ls.StatusCode = 'c' then 1 else 0 end as Completed_FileCount
,case when ls.StatusCode = 'e' then 1 else 0 end as Error_FileCount

---Dates
,ls.CreatedTimeStamp as LoadStatus_CreatedTimeStamp
,ls.JobStartDateTime
,cast(ls.JobStartDateTime as date) as JobStartDate
,cast(ls.JobStartDateTime as time(0)) as JobStartTime

--- Job Start Filters
,case when cast(ls.JobStartDateTime as date) = cast(GetDate() as date) then 1 else 0 end as JobStart_Today
,case when cast(ls.JobStartDateTime as date) = cast(GetDate() -1  as date )  then 1 else 0 end as JobStart_Yesterday


---Today File Count #s
,case when cast(ls.JobStartDateTime as date) = cast(GetDate() as date ) AND ls.OriginalFileName IS NOT NULL then 1 else NULL end as Today_Original_FileCount
,case when cast(ls.JobStartDateTime as date) = cast(GetDate() as date ) AND ls.StatusCode = 'c' AND ls.OriginalFileName IS NOT NULL then 1 else NULL end as Today_Completed_FileCount
,case when cast(ls.JobStartDateTime as date) = cast(GetDate() as date ) AND ls.StatusCode = 'e' AND ls.OriginalFileName IS NOT NULL then 1 else NULL end as Today_Error_FileCount



---Yesterday File Count #s
,case when cast(ls.JobStartDateTime as date) = cast(GetDate() -1  as date ) AND ls.OriginalFileName IS NOT NULL then 1 else NULL end as Yesterday_Original_FileCount
,case when cast(ls.JobStartDateTime as date) = cast(GetDate() -1  as date ) AND ls.StatusCode = 'c' AND ls.OriginalFileName IS NOT NULL then 1 else NULL end as Yesterday_Completed_FileCount
,case when cast(ls.JobStartDateTime as date) = cast(GetDate() -1  as date ) AND ls.StatusCode = 'e' AND ls.OriginalFileName IS NOT NULL then 1 else NULL end as Yesterday_Error_FileCount



FROM Automation.Clients as cl
JOIN Automation.LoadStatus as ls ON cl.ID=ls.ClientID

order by ls.JobStartDateTime DESC
